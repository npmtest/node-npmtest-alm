<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for node-npmtest-alm/node_modules/alm/src/server/workers/lang/core/compilationContextExpander.js</title>
    <meta charset="utf-8">
    <style>
        body, html {
            margin:0; padding: 0;
        }
        body {
            font-family: Arial, Helvetica;
            font-size: 10pt;
        }
        div.header, div.footer {
            background: #eee;
            padding: 1em;
        }
        div.header {
            height: 160px;
            padding: 0 1em 0 1em;
            z-index: 100;
            position: fixed;
            top: 0;
            border-bottom: 1px solid #666;
            width: 100%;
        }
        div.footer {
            border-top: 1px solid #666;
        }
        div.body {
            margin-top: 170px;
        }
        div.meta {
            font-size: 90%;
            text-align: center;
        }
        h1, h2, h3 {
            font-weight: normal;
        }
        h1 {
            font-size: 12pt;
        }
        h2 {
            font-size: 10pt;
        }
        pre {
            font-family: Menlo, Monaco, Consolas, Courier New, monospace;
            margin: 0;
            padding: 0;
            font-size: 14px;
            tab-size: 2;
        }

        div.path { font-size: 110%; }
        div.path a:link, div.path a:visited { color: #000; }
        table.coverage { border-collapse: collapse; margin:0; padding: 0 }

        table.coverage td {
            margin: 0;
            padding: 0;
            color: #111;
            vertical-align: top;
        }
        table.coverage td.line-count {
            width: 50px;
            text-align: right;
            padding-right: 5px;
        }
        table.coverage td.line-coverage {
            color: #777 !important;
            text-align: right;
            border-left: 1px solid #666;
            border-right: 1px solid #666;
        }

        table.coverage td.text {
        }

        table.coverage td span.cline-any {
            display: inline-block;
            padding: 0 5px;
            width: 40px;
        }
        table.coverage td span.cline-neutral {
            background: #eee;
        }
        table.coverage td span.cline-yes {
            background: #b5d592;
            color: #999;
        }
        table.coverage td span.cline-no {
            background: #fc8c84;
        }

        .cstat-yes { color: #111; }
        .cstat-no { background: #fc8c84; color: #111; }
        .fstat-no { background: #ffc520; color: #111 !important; }
        .cbranch-no { background:  yellow !important; color: #111; }

        .cstat-skip { background: #ddd; color: #111; }
        .fstat-skip { background: #ddd; color: #111 !important; }
        .cbranch-skip { background: #ddd !important; color: #111; }

        .missing-if-branch {
            display: inline-block;
            margin-right: 10px;
            position: relative;
            padding: 0 4px;
            background: black;
            color: yellow;
        }

        .skip-if-branch {
            display: none;
            margin-right: 10px;
            position: relative;
            padding: 0 4px;
            background: #ccc;
            color: white;
        }

        .missing-if-branch .typ, .skip-if-branch .typ {
            color: inherit !important;
        }

        .entity, .metric { font-weight: bold; }
        .metric { display: inline-block; border: 1px solid #333; padding: 0.3em; background: white; }
        .metric small { font-size: 80%; font-weight: normal; color: #666; }

        div.coverage-summary table { border-collapse: collapse; margin: 3em; font-size: 110%; }
        div.coverage-summary td, div.coverage-summary table  th { margin: 0; padding: 0.25em 1em; border-top: 1px solid #666; border-bottom: 1px solid #666; }
        div.coverage-summary th { text-align: left; border: 1px solid #666; background: #eee; font-weight: normal; }
        div.coverage-summary th.file { border-right: none !important; }
        div.coverage-summary th.pic { border-left: none !important; text-align: right; }
        div.coverage-summary th.pct { border-right: none !important; }
        div.coverage-summary th.abs { border-left: none !important; text-align: right; }
        div.coverage-summary td.pct { text-align: right; border-left: 1px solid #666; }
        div.coverage-summary td.abs { text-align: right; font-size: 90%; color: #444; border-right: 1px solid #666; }
        div.coverage-summary td.file { text-align: right; border-left: 1px solid #666; white-space: nowrap;  }
        div.coverage-summary td.pic { min-width: 120px !important;  }
        div.coverage-summary a:link { color: #000; }
        div.coverage-summary a:visited { color: #333; }
        div.coverage-summary tfoot td { border-top: 1px solid #666; }

        div.coverage-summary .yui3-datatable-sort-indicator, div.coverage-summary .dummy-sort-indicator {
            height: 10px;
            width: 7px;
            display: inline-block;
            margin-left: 0.5em;
        }
        div.coverage-summary .yui3-datatable-sort-indicator {
            background: no-repeat scroll 0 0 transparent;
        }
        div.coverage-summary .yui3-datatable-sorted .yui3-datatable-sort-indicator {
            background-position: 0 -20px;
        }
        div.coverage-summary .yui3-datatable-sorted-desc .yui3-datatable-sort-indicator {
            background-position: 0 -10px;
        }

        .high { background: #b5d592 !important; }
        .medium { background: #ffe87c !important; }
        .low { background: #fc8c84 !important; }

        span.cover-fill, span.cover-empty {
            display:inline-block;
            border:1px solid #444;
            background: white;
            height: 12px;
        }
        span.cover-fill {
            background: #ccc;
            border-right: 1px solid #444;
        }
        span.cover-empty {
            background: white;
            border-left: none;
        }
        span.cover-full {
            border-right: none !important;
        }
        pre.prettyprint {
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        .com { color: #999 !important; }
        .ignore-none { color: #999; font-weight: normal; }

    </style>
</head>
<body>
<div class="header low">
    <h1 style="font-weight: bold;">
        <a href="https://github.com/npmtest/node-npmtest-alm">npmtest-alm (v0.0.1)</a>
    </h1>
    <h1>Code coverage report for <span class="entity">node-npmtest-alm/node_modules/alm/src/server/workers/lang/core/compilationContextExpander.js</span></h1>
    <h2>
        
        Statements: <span class="metric">11.43% <small>(12 / 105)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Branches: <span class="metric">0% <small>(0 / 30)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Functions: <span class="metric">0% <small>(0 / 24)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Lines: <span class="metric">11.76% <small>(12 / 102)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../../../../../../../index.html">All files</a> &#187; <a href="index.html">node-npmtest-alm/node_modules/alm/src/server/workers/lang/core/</a> &#187; compilationContextExpander.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182</td><td class="line-coverage"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var utils_1 = require("../../../../common/utils");
var fmc = require("../../../disk/fileModelCache");
var path = require("path");
var fsu = require("../../../utils/fsu");
/**
 * The files that you provide in a tsconfig.json might not be the *complete* set of files
 * We preprocess these files to add additional files based on the contents of these files
 */
<span class="fstat-no" title="function not covered" >function increaseCompilationContext(files, allowJs) {</span>
<span class="cstat-no" title="statement not covered" >    var filesMap = utils_1.createMap(files);</span>
<span class="cstat-no" title="statement not covered" >    var willNeedMoreAnalysis = <span class="fstat-no" title="function not covered" >function (file) {</span></span>
<span class="cstat-no" title="statement not covered" >        if (!filesMap[file]) {</span>
<span class="cstat-no" title="statement not covered" >            filesMap[file] = true;</span>
<span class="cstat-no" title="statement not covered" >            files.push(file);</span>
<span class="cstat-no" title="statement not covered" >            return true;</span>
        }
        else {
<span class="cstat-no" title="statement not covered" >            return false;</span>
        }
    };
<span class="cstat-no" title="statement not covered" >    var getReferencedOrImportedFiles = <span class="fstat-no" title="function not covered" >function (files) {</span></span>
<span class="cstat-no" title="statement not covered" >        var referenced = [];</span>
<span class="cstat-no" title="statement not covered" >        files.forEach(<span class="fstat-no" title="function not covered" >function (file) {</span></span>
<span class="cstat-no" title="statement not covered" >            try {</span>
<span class="cstat-no" title="statement not covered" >                var content = fmc.getOrCreateOpenFile(file).getContents();</span>
            }
            catch (ex) {
                // if we cannot read a file for whatever reason just quit
<span class="cstat-no" title="statement not covered" >                return;</span>
            }
<span class="cstat-no" title="statement not covered" >            var preProcessedFileInfo = ts.preProcessFile(content, true), dir = path.dirname(file);</span>
<span class="cstat-no" title="statement not covered" >            var extensions = ['.ts', '.d.ts', '.tsx'];</span>
<span class="cstat-no" title="statement not covered" >            if (allowJs) {</span>
<span class="cstat-no" title="statement not covered" >                extensions.push('.js');</span>
<span class="cstat-no" title="statement not covered" >                extensions.push('.jsx');</span>
            }
<span class="fstat-no" title="function not covered" >            function getIfExists(filePathNoExt) {</span>
<span class="cstat-no" title="statement not covered" >                for (var _i = 0, extensions_1 = extensions; _i &lt; extensions_1.length; _i++) {</span>
<span class="cstat-no" title="statement not covered" >                    var ext = extensions_1[_i];</span>
<span class="cstat-no" title="statement not covered" >                    if (fsu.existsSync(filePathNoExt + ext)) {</span>
<span class="cstat-no" title="statement not covered" >                        return filePathNoExt + ext;</span>
                    }
                }
            }
<span class="cstat-no" title="statement not covered" >            referenced.push(preProcessedFileInfo.referencedFiles.map(<span class="fstat-no" title="function not covered" >function (fileReference) {</span></span>
                // We assume reference paths are always relative
<span class="cstat-no" title="statement not covered" >                var file = path.resolve(dir, fsu.consistentPath(fileReference.fileName));</span>
                // Try by itself then with extensions
<span class="cstat-no" title="statement not covered" >                if (fsu.existsSync(file)) {</span>
<span class="cstat-no" title="statement not covered" >                    return file;</span>
                }
<span class="cstat-no" title="statement not covered" >                return getIfExists(file);</span>
            }).filter(<span class="fstat-no" title="function not covered" >function (file) {</span> <span class="cstat-no" title="statement not covered" >return !!file; </span>})
                .concat(preProcessedFileInfo.importedFiles
                .filter(<span class="fstat-no" title="function not covered" >function (fileReference) {</span> <span class="cstat-no" title="statement not covered" >return fsu.isRelative(fileReference.fileName); </span>})
                .map(<span class="fstat-no" title="function not covered" >function (fileReference) {</span>
<span class="cstat-no" title="statement not covered" >                var fileNoExt = path.resolve(dir, fileReference.fileName);</span>
<span class="cstat-no" title="statement not covered" >                var file = getIfExists(fileNoExt);</span>
<span class="cstat-no" title="statement not covered" >                if (!file) {</span>
<span class="cstat-no" title="statement not covered" >                    file = getIfExists(file + "/index");</span>
                }
<span class="cstat-no" title="statement not covered" >                return file;</span>
            }).filter(<span class="fstat-no" title="function not covered" >function (file) {</span> <span class="cstat-no" title="statement not covered" >return !!file; </span>})));
        });
<span class="cstat-no" title="statement not covered" >        return utils_1.selectMany(referenced);</span>
    };
<span class="cstat-no" title="statement not covered" >    var more = getReferencedOrImportedFiles(files)</span>
        .filter(willNeedMoreAnalysis);
<span class="cstat-no" title="statement not covered" >    while (more.length) {</span>
<span class="cstat-no" title="statement not covered" >        more = getReferencedOrImportedFiles(files)</span>
            .filter(willNeedMoreAnalysis);
    }
<span class="cstat-no" title="statement not covered" >    return files;</span>
}
exports.increaseCompilationContext = increaseCompilationContext;
/**
 *  Spec
 *  We will expand on files making sure that we don't have a `typing` with the same name
 *  Also if two node_modules reference a similar sub project (and also recursively) then the one with latest `version` field wins
 */
<span class="fstat-no" title="function not covered" >function getDefinitionsForNodeModules(projectDir, files) {</span>
<span class="cstat-no" title="statement not covered" >    var packagejson = [];</span>
    /** TODO use later when we care about versions */
<span class="fstat-no" title="function not covered" >    function versionStringToNumber(version) {</span>
<span class="cstat-no" title="statement not covered" >        var _a = version.split('.'), maj = _a[0], min = _a[1], patch = _a[2];</span>
<span class="cstat-no" title="statement not covered" >        return parseInt(maj) * 1000000 + parseInt(min);</span>
    }
<span class="cstat-no" title="statement not covered" >    var typings = {};</span>
    // Find our `typings` (anything in a typings folder with extension `.d.ts` is considered a typing)
    // These are INF powerful
<span class="cstat-no" title="statement not covered" >    var ourTypings = files</span>
        .filter(<span class="fstat-no" title="function not covered" >function (f) {</span> <span class="cstat-no" title="statement not covered" >return path.basename(path.dirname(f)) == 'typings' &amp;&amp; f.endsWith('.d.ts')</span>
        || path.basename(path.dirname(path.dirname(f))) == 'typings' &amp;&amp; f.endsWith('.d.ts'); });
<span class="cstat-no" title="statement not covered" >    ourTypings.forEach(<span class="fstat-no" title="function not covered" >function (f) {</span> <span class="cstat-no" title="statement not covered" >return typings[path.basename(f)] = { filePath: f, version: Infinity }; </span>});</span>
<span class="cstat-no" title="statement not covered" >    var existing = utils_1.createMap(files.map(fsu.consistentPath));</span>
<span class="fstat-no" title="function not covered" >    function addAllReferencedFilesWithMaxVersion(file) {</span>
<span class="cstat-no" title="statement not covered" >        var dir = path.dirname(file);</span>
<span class="cstat-no" title="statement not covered" >        try {</span>
<span class="cstat-no" title="statement not covered" >            var content = fmc.getOrCreateOpenFile(file).getContents();</span>
        }
        catch (ex) {
            // if we cannot read a file for whatever reason just quit
<span class="cstat-no" title="statement not covered" >            return;</span>
        }
<span class="cstat-no" title="statement not covered" >        var preProcessedFileInfo = ts.preProcessFile(content, true);</span>
<span class="cstat-no" title="statement not covered" >        var files = preProcessedFileInfo.referencedFiles.map(<span class="fstat-no" title="function not covered" >function (fileReference) {</span></span>
            // We assume reference paths are always relative
<span class="cstat-no" title="statement not covered" >            var file = path.resolve(dir, fileReference.fileName);</span>
            // Try by itself, .d.ts
<span class="cstat-no" title="statement not covered" >            if (fsu.existsSync(file)) {</span>
<span class="cstat-no" title="statement not covered" >                return file;</span>
            }
<span class="cstat-no" title="statement not covered" >            if (fsu.existsSync(file + '.tsx')) {</span>
<span class="cstat-no" title="statement not covered" >                return file + '.tsx';</span>
            }
<span class="cstat-no" title="statement not covered" >            if (fsu.existsSync(file + '.d.ts')) {</span>
<span class="cstat-no" title="statement not covered" >                return file + '.d.ts';</span>
            }
        }).filter(<span class="fstat-no" title="function not covered" >function (f) {</span> <span class="cstat-no" title="statement not covered" >return !!f; </span>});
        // Only ones we don't have by name yet
        // TODO: replace INF with an actual version
<span class="cstat-no" title="statement not covered" >        files = files</span>
            .filter(<span class="fstat-no" title="function not covered" >function (f) {</span> <span class="cstat-no" title="statement not covered" >return !typings[path.basename(f)] || typings[path.basename(f)].version &gt; Infinity; </span>});
        // Add these
<span class="cstat-no" title="statement not covered" >        files.forEach(<span class="fstat-no" title="function not covered" >function (f) {</span> <span class="cstat-no" title="statement not covered" >return typings[path.basename(f)] = { filePath: f, version: Infinity }; </span>});</span>
        // Keep expanding
<span class="cstat-no" title="statement not covered" >        files.forEach(<span class="fstat-no" title="function not covered" >function (f) {</span> <span class="cstat-no" title="statement not covered" >return addAllReferencedFilesWithMaxVersion(f); </span>});</span>
    }
    // Keep going up till we find node_modules
    // at that point read the `package.json` for each file in node_modules
    // And then if that package.json has `typescript.definition` we import that file
<span class="cstat-no" title="statement not covered" >    try {</span>
<span class="cstat-no" title="statement not covered" >        var node_modules = fsu.travelUpTheDirectoryTreeTillYouFind(projectDir, 'node_modules', true);</span>
        // For each sub directory of node_modules look at package.json and then `typescript.definition`
<span class="cstat-no" title="statement not covered" >        var moduleDirs = fsu.getDirs(node_modules);</span>
<span class="cstat-no" title="statement not covered" >        for (var _i = 0, moduleDirs_1 = moduleDirs; _i &lt; moduleDirs_1.length; _i++) {</span>
<span class="cstat-no" title="statement not covered" >            var moduleDir = moduleDirs_1[_i];</span>
<span class="cstat-no" title="statement not covered" >            try {</span>
<span class="cstat-no" title="statement not covered" >                var package_json = JSON.parse(fmc.getOrCreateOpenFile(moduleDir + "/package.json").getContents());</span>
<span class="cstat-no" title="statement not covered" >                packagejson.push(moduleDir + "/package.json");</span>
            }
            catch (ex) {
                // Can't read package.json ... no worries ... move on to other modules
<span class="cstat-no" title="statement not covered" >                continue;</span>
            }
<span class="cstat-no" title="statement not covered" >            if (package_json.typescript &amp;&amp; package_json.typescript.definition) {</span>
<span class="cstat-no" title="statement not covered" >                var file = path.resolve(moduleDir, './', package_json.typescript.definition);</span>
                /** If the file configuration points to a valid file */
<span class="cstat-no" title="statement not covered" >                if (fsu.existsSync(file)) {</span>
<span class="cstat-no" title="statement not covered" >                    typings[path.basename(file)] = {</span>
                        filePath: file,
                        version: Infinity
                    };
                    // Also add any files that this `.d.ts` references as long as they don't conflict with what we have
<span class="cstat-no" title="statement not covered" >                    addAllReferencedFilesWithMaxVersion(file);</span>
                }
            }
        }
    }
    catch (ex) {
<span class="cstat-no" title="statement not covered" >        if (ex.message == "not found") {</span>
            // Sure we didn't find node_modules
            // Thats cool
        }
        else {
<span class="cstat-no" title="statement not covered" >            console.error('Failed to read package.json from node_modules due to error:', ex, ex.stack);</span>
        }
    }
<span class="cstat-no" title="statement not covered" >    var all = Object.keys(typings)</span>
        .map(<span class="fstat-no" title="function not covered" >function (typing) {</span> <span class="cstat-no" title="statement not covered" >return typings[typing].filePath; </span>})
        .map(<span class="fstat-no" title="function not covered" >function (x) {</span> <span class="cstat-no" title="statement not covered" >return fsu.consistentPath(x); </span>});
<span class="cstat-no" title="statement not covered" >    var implicit = all</span>
        .filter(<span class="fstat-no" title="function not covered" >function (x) {</span> <span class="cstat-no" title="statement not covered" >return !existing[x]; </span>});
<span class="cstat-no" title="statement not covered" >    var ours = all</span>
        .filter(<span class="fstat-no" title="function not covered" >function (x) {</span> <span class="cstat-no" title="statement not covered" >return existing[x]; </span>});
<span class="cstat-no" title="statement not covered" >    return { implicit: implicit, ours: ours, packagejson: packagejson };</span>
}
exports.getDefinitionsForNodeModules = getDefinitionsForNodeModules;
&nbsp;
&nbsp;</pre></td></tr>
</table></pre>
</div>
<div class="footer">
    <div class="meta">Generated by <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a> at Thu Apr 20 2017 04:39:39 GMT+0000 (UTC)</div>
</div>
</body>
</html>
